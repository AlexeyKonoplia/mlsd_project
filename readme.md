# ML System Design Document
## Система прогнозирования спроса для сети супермаркетов

Распределение ролей: 
- Системный писатель - Федак Андрей
- Data Science, System Architect - Конопля Алексей

### 1. Цели и предпосылки

#### 1.1 Бизнес-цель
Оптимизировать управление товарными запасами и логистикой путем точного прогнозирования спроса на товары в каждой точке продаж сети супермаркетов для минимизации потерь от просроченных товаров и упущенной выручки.

#### 1.2 Зачем идем в разработку продукта
Текущий процесс заказа товаров основан на интуиции менеджеров, что приводит к систематическим ошибкам планирования. Ручное управление запасами в масштабе 500 магазинов с 10,000 уникальными товарами неэффективно и ведет к значительным финансовым потерям.

[BPMN диаграммы до и после внедрения системы](diagrams/business/before_and_after.md)

#### 1.3 Преимущества использования ML
- Автоматизация процесса прогнозирования спроса на основе исторических данных
- Учет сезонности, трендов и локальных особенностей каждого магазина
- Снижение человеческого фактора в принятии решений
- Масштабируемость решения на всю сеть магазинов
- Непрерывное улучшение качества прогнозов за счет обучения на новых данных

#### 1.4 Бизнес-требования и ограничения
**Бизнес-требования:**
- Прогнозирование спроса на период от 1 до 30 дней
- Покрытие всех 10,000 товаров в 500 магазинах
- Интеграция с существующими ERP и WMS системами
- Автоматическое формирование заказов поставщикам
- Отчетность для менеджмента по эффективности системы

**Ограничения:**
- Бюджет на разработку и внедрение системы
- Сроки внедрения (не более 12 месяцев)
- Необходимость минимального прерывания текущих бизнес-процессов
- Требования к безопасности коммерческих данных
- Интеграция с унаследованными системами

#### 1.5 Функциональные требования
- Ежедневное прогнозирование спроса по каждому товару в каждом магазине
- Учет внешних факторов (праздники, акции, погода)
- Автоматическое определение оптимального уровня запасов
- Генерация заказов поставщикам с учетом сроков поставки
- Мониторинг точности прогнозов и корректировка моделей
- Интерфейс для категорийных менеджеров с возможностью ручной корректировки
- Система алертов при критических отклонениях спроса

#### 1.6 Нефункциональные требования
- **Производительность:** Обработка прогнозов для всех товаров в течение 2 часов
- **Доступность:** 99.5% uptime в рабочие часы
- **Latency:** Время отклика интерфейса не более 3 секунд
- **Масштабируемость:** Возможность расширения до 1000 магазинов
- **Безопасность:** Соответствие стандартам защиты коммерческих данных
- **Отказоустойчивость:** Возможность работы при выходе из строя отдельных компонентов

#### 1.7 Процесс пилота и критерии успеха
**Пилот будет проведен на 10 магазинах с 500 наиболее популярными товарами в течение 3 месяцев.**

**Критерии успеха пилота:**
- Снижение потерь от просроченных товаров на 15%
- Уменьшение случаев отсутствия товара на полках на 20%
- Повышение точности прогнозирования до 85% (MAPE < 15%)
- Экономия времени менеджеров на планирование запасов на 50%

#### 1.8 MVP vs техдолг
**MVP включает:**
- Базовые модели прогнозирования для топ-20% товаров по выручке
- Интеграция с основной ERP системой
- Простой веб-интерфейс для просмотра прогнозов
- Автоматическое формирование заказов для пилотных магазинов

**Техдолг (следующие итерации):**
- Модели для длиннохвостых товаров
- Интеграция с системами погоды и социальных событий
- Мобильное приложение для менеджеров магазинов
- Продвинутая аналитика и A/B тестирование

### 2. Методология

#### 2.1 Техническое решение
Задача представляет собой **регрессионную задачу временных рядов** с элементами многомерного прогнозирования. Для решения будут использованы:
- Классические методы временных рядов (ARIMA, Exponential Smoothing)
- Градиентный бустинг (XGBoost, LightGBM) для учета внешних факторов
- Рекуррентные нейронные сети (LSTM/GRU) для сложных паттернов
- Ансамблевые методы для повышения робастности

#### 2.2 Необходимые данные
**Критически важные данные:**
- Исторические данные продаж по товарам и магазинам за 2+ года
- Информация о товарах (категория, цена, срок годности, сезонность)
- Данные о магазинах (локация, размер, тип района)
- Календарные данные (праздники, выходные, школьные каникулы)

**Дополнительные данные для улучшения качества:**
- Данные о маркетинговых акциях и скидках
- Информация о конкурентах в районе магазина
- Погодные данные
- Экономические индикаторы региона
- Данные о поставках и логистике

#### 2.3 Метрики качества ML
**Основные метрики:**
- MAPE (Mean Absolute Percentage Error) - целевое значение < 15%
- RMSE (Root Mean Square Error) - для штрафования больших ошибок
- Weighted MAPE - с учетом важности товаров по выручке
- Forecast Bias - для выявления систематических ошибок

**Связь с бизнес-результатом:**
- Снижение MAPE на 1% = экономия 0.5% от оборота категории
- Уменьшение случаев отсутствия товара коррелирует с точностью прогноза (R² = 0.7)
- ROI системы = (Экономия от снижения потерь + Дополнительная выручка) / Затраты на разработку

#### 2.4 Риски этапа анализа и моделирования
**Риски и митигация:**
- **Качество исторических данных:** Аудит данных, очистка, заполнение пропусков
- **Сезонность и тренды:** Использование методов декомпозиции временных рядов
- **Новые товары:** Модели cold-start на основе похожих товаров
- **Внешние шоки:** Мониторинг аномалий и быстрая переобучение моделей
- **Переобучение:** Валидация на независимой тестовой выборке, регуляризация

### 3. Подготовка пилота

#### 3.1 Способ оценки пилота
Оценка будет проводиться через сравнение ключевых метрик до и после внедрения системы в пилотных магазинах, с использованием контрольной группы магазинов, работающих по старой схеме.

#### 3.2 Определение успешного пилота
Пилот считается успешным при достижении следующих результатов:
- Снижение потерь от списания просроченных товаров на 15%
- Уменьшение потерь от упущенных продаж на 20%
- Повышение оборачиваемости запасов на 10%
- Положительная оценка удобства системы от пользователей (NPS > 50)

#### 3.3 Подготовка пилота
**Этапы подготовки:**
1. Отбор пилотных магазинов с различными характеристиками
2. Настройка интеграции с существующими системами
3. Обучение персонала работе с новой системой
4. Создание процедур мониторинга и эскалации проблем
5. Разработка плана отката в случае критических проблем

#### 3.4 Внедрение для production системы
**Поэтапное внедрение:**
1. Постепенное расширение на все магазины сети (по 50 магазинов в месяц)
2. Добавление новых категорий товаров
3. Интеграция дополнительных источников данных
4. Внедрение продвинутых функций аналитики

### 4. Архитектура решения

[Диаграмма архитектуры разрабатываемой системы](diagrams/data_architecture/architecture.md)

#### 4.1 Общая архитектура системы
Система построена на микросервисной архитектуре с использованием принципов Event-Driven Architecture для обеспечения масштабируемости и отказоустойчивости.

**Основные компоненты:**
- **Data Ingestion Service** - сбор данных из различных источников
- **Data Processing Pipeline** - ETL процессы и подготовка данных
- **ML Training Service** - обучение и валидация моделей
- **Prediction Service** - генерация прогнозов в реальном времени
- **API Gateway** - единая точка входа для всех клиентов
- **Web Application** - пользовательский интерфейс
- **Notification Service** - система алертов и уведомлений
- **Monitoring & Logging** - мониторинг системы и аудит

#### 4.2 Инфраструктура и масштабируемость
**Выбранная инфраструктура: Kubernetes на AWS**

**Преимущества:**
- Автоматическое масштабирование под нагрузкой
- Высокая доступность через репликацию сервисов
- Простота развертывания и обновления
- Экономия на инфраструктуре через оптимизацию ресурсов

**Недостатки:**
- Сложность начальной настройки
- Необходимость экспертизы в области DevOps
- Зависимость от облачного провайдера  

**Хранение данных**  
[Диаграмма структуры данных](diagrams/data_structure/datastracture.md)  

#### 4.3 Требования к работе системы
- **SLA:** 99.5% доступности в рабочие часы (7:00-23:00)
- **RPS:** 1000 запросов в секунду в пиковые часы
- **Latency:** 
  - API запросы: < 200ms (95-й перцентиль)
  - Генерация прогнозов: < 2 часа для полного цикла
  - Веб-интерфейс: < 3 секунды загрузка страницы
- **Пропускная способность:** Обработка 5M транзакций в день

#### 4.4 Риски и неопределенности
**Технические риски:**
- Отказ критических компонентов системы - митигация через резервирование
- Деградация качества моделей - автоматический мониторинг и переобучение
- Проблемы интеграции с legacy системами - поэтапная интеграция с fallback
- Недостаточная производительность - горизонтальное масштабирование

**Бизнес-риски:**
- Сопротивление пользователей изменениям - программа change management
- Неточность прогнозов в начальный период - ручная корректировка и обучение
- Изменение бизнес-процессов поставщиков - гибкость архитектуры

[Диаграмма последовательности использования системы](diagrams/UML/sequence.md)
### 5. Заключение

Представленная система прогнозирования спроса для сети супермаркетов обеспечивает комплексное решение проблемы оптимизации товарных запасов. Использование современных методов машинного обучения в сочетании с масштабируемой архитектурой позволит значительно повысить эффективность управления запасами и увеличить прибыльность бизнеса.

Ключевые преимущества решения включают автоматизацию процесса принятия решений, высокую точность прогнозирования, масштабируемость на всю сеть магазинов и интеграцию с существующими бизнес-процессами. Поэтапный подход к внедрению через пилотный проект минимизирует риски и позволяет продемонстрировать ценность решения до полномасштабного развертывания.
